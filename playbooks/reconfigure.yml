---
- name: Deregister deleted Openstack Computes
  include: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/deregister_compute.yml"
  vars:
    dir: "{{ playbook_dir }}/../../contrail-kolla-ansible/etc/kolla"
    extensions: ['yml']
    deleted_nodes_dict: "{{ hostvars['localhost'].deleted_nodes_dict }}"
    openstack_controller: "{{ hostvars['localhost'].openstack_controller }}"
    contrail_configuration: "{{ hostvars['localhost'].contrail_configuration }}"
  tags: nova

- name: Destroy Deleted Openstack Nodes
  include: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/destroy.yml"
  vars:
    dir: "{{ playbook_dir }}/../../contrail-kolla-ansible/etc/kolla"
    extensions: ['yml']
    deleted_nodes_dict: "{{ hostvars['localhost'].deleted_nodes_dict }}"
    openstack_controller: "{{ hostvars['localhost'].openstack_controller }}"
    contrail_cleanup: true
    destroy_include_images: "{{ enable_destroy_images | default('no') }}"
  when:
    - hostvars['localhost'].deleted_nodes_dict.keys() | length > 0
    - inventory_hostname in hostvars['localhost'].deleted_nodes_dict.values()
  tags: nova
