- name: Create container host group
  hosts: localhost
  connection: local
  gather_facts: yes
  pre_tasks:
    - name: Set orchestrator if not passed
      set_fact:
          contrail_configuration: "{{ contrail_configuration|default({}) | combine({'CLOUD_ORCHESTRATOR': orchestrator if orchestrator is defined else 'openstack'}) }}"
      when: contrail_configuration is not defined or contrail_configuration.CLOUD_ORCHESTRATOR is not defined
    - name: Expose instances
      set_fact:
          instances: "{{ instances }}"
      when: hostvars['localhost']['instances'] is undefined

  roles:
  - create_container_host_group
  - { role: create_kolla_playbooks }
  - { role: install_kolla_dependencies, when: contrail_configuration.CLOUD_ORCHESTRATOR == 'openstack' }
  vars_files:
    - "{{ config_file }}"

- name: Configure instance(s)
  hosts: container_hosts
  gather_facts: yes
  roles:
  - configure_instances
  vars_files:
  - "{{ hostvars['localhost'].config_file }}"
  environment:
   - https_proxy: "{{ contrail_configuration.HTTPS_PROXY|default('') }}"
   - http_proxy: "{{ contrail_configuration.HTTP_PROXY|default('') }}"

- name: Setup contrail_configuration for localhost
  hosts: container_hosts
  gather_facts: yes
  pre_tasks:
    - name: Import contrail_configuration
      set_fact:
          contrail_configuration: "{{ contrail_configuration|default({}) }}"
  vars_files:
  - "{{ hostvars['localhost'].config_file }}"

- name: Set Common SSL Enable flag for cert creation
  set_fact:
    ssl_cert_create: true
  when:
    - (( contrail_configuration.SSL_ENABLE is defined ) and
      ( contrail_configuration.SSL_ENABLE|bool )) or
      (( contrail_configuration.XMPP_SSL_ENABLE is defined ) and
      ( contrail_configuration.XMPP_SSL_ENABLE|bool )) or
      (( contrail_configuration.INTROSPECT_SSL_ENABLE is defined ) and
      ( contrail_configuration.INTROSPECT_SSL_ENABLE|bool )) or
      (( contrail_configuration.SANDESH_SSL_ENABLE is defined ) and
      ( contrail_configuration.SANDESH_SSL_ENABLE|bool ))
  tags:
   - always

- name: Configure SSL
  hosts: container_hosts
  gather_facts: yes
  tasks:
    - name: Generate and Copy SSL Certs for all hosts
      include_role:
        name: configure_instances
        tasks_from: configure_ssl_certs.yml
      when: ssl_cert_create is defined and ssl_cert_create == true
