---
- name: create container hostgroups for destroyer
  hosts: localhost
  connection: local
  gather_facts: no
  pre_tasks:
    - name: Expose instances
      set_fact:
          instances: "{{ instances }}"
      when: hostvars['localhost']['instances'] is undefined
    - name: Expose global configuration
      set_fact:
          global_configuration: "{{ global_configuration | default({}) }}"
      when: hostvars['localhost']['global_configuration'] is undefined
    - name: Expose remote_locations configuration
      set_fact:
          remote_locations: "{{ remote_locations | default({}) }}"
      when: hostvars['localhost']['remote_locations'] is undefined
  roles:
    - name: Generate container_host group
      role: create_container_host_group
    - name: Generate openstack host groups
      role: create_openstack_host_group
    - name: Set Global Configuration
      role: set_global_variables
    - name: Build node lists
      role: build_node_lists
    - name: Create Contrail Variables
      role: set_contrail_variables
  vars_files:
    - "{{ config_file }}"

- name: Remove Openstack Compute role from Openstack Controllers
  hosts: control
  tasks:
  - name: Import group variables
    include_vars:
      dir: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/group_vars"
      extensions: ['yml']

  - name: Import global variables
    include_vars:
      dir: "{{ playbook_dir }}/../../contrail-kolla-ansible/etc/kolla"
      extensions: ['yml']
      ignore_files:
        - passwords.yml.original
        - globals.yml.original

  - name: set tmphost
    set_fact:
      tmp_host: "{{ inventory_hostname }}"

  - stat:
      path: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/host_vars/{{ tmp_host }}.yml"
    register: st
    delegate_to: localhost

  - name: Import host variables
    include_vars:
      file: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/host_vars/{{ inventory_hostname }}.yml"
    when: st.stat.exists is defined and st.stat.exists

  - name: Do Nova Compute Specific steps to remove the compute node(s)
    include_tasks: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/remove-contrail-compute.yml"
    run_once: yes
    vars:
      dir:
        - "{{ playbook_dir }}/../../contrail-kolla-ansible/etc/kolla"
        - "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/group_vars"
      extensions: ['yml']
      instances: "{{ hostvars['localhost'].instances }}"
      roles: "{{ hostvars['localhost'].roles }}"

- name: Destroy Openstack Compute Node
  hosts: compute
  tasks:
  - name: Import group variables
    include_vars:
      dir: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/group_vars"
      extensions: ['yml']

  - name: Import global variables
    include_vars:
      dir: "{{ playbook_dir }}/../../contrail-kolla-ansible/etc/kolla"
      extensions: ['yml']
      ignore_files:
        - passwords.yml.original
        - globals.yml.original

  - name: set tmphost
    set_fact:
      tmp_host: "{{ inventory_hostname }}"

  - stat:
      path: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/host_vars/{{ tmp_host }}.yml"
    register: st
    delegate_to: localhost

  - name: Import host variables
    include_vars:
      file: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/host_vars/{{ inventory_hostname }}.yml"
    when: st.stat.exists is defined and st.stat.exists

  - name: include kolla ansisble destroy directly
    include_role:
      name: "{{ playbook_dir }}/../../contrail-kolla-ansible/ansible/roles/destroy"
    vars:
      dir: "{{ playbook_dir }}/../../contrail-kolla-ansible/etc/kolla"
      extensions: ['yml']
      contrail_cleanup: true
      destroy_include_images: "{{ enable_destroy_images | default('no') }}" 

- name: Apply role destroy to contrail compute
  hosts: compute 
  roles:
    - remove_contrail_compute
    - destroy
  vars:
    - global_configuration: "{{ hostvars['localhost'].global_configuration }}"
    - cluster_configuration: "{{ hostvars['localhost'].contrail_configuration }}"
    - instances: "{{ hostvars['localhost'].instances }}"
    - roles: "{{ hostvars['localhost'].roles }}"
