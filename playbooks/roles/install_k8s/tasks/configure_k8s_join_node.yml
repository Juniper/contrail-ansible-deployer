---
- name: docker info for getting cgroup driver
  shell: docker info 2>/dev/null |grep "Cgroup Driver" |awk '{print $3}'
  register: docker_info

- name: get cgroup driver
  set_fact:
    cgroup_driver: "{{ docker_info.stdout }}"

- name: set cgroup driver to cgroupfs
  lineinfile:
    path: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    regexp: '^Environment="KUBELET_CGROUP_ARGS=--cgroup-driver=.*"'
    line: 'Environment="KUBELET_CGROUP_ARGS=--cgroup-driver={{ cgroup_driver }}"'

- name: reset k8s node
  shell: |
      kubeadm reset &&
      rm -rf $HOME/.kube

- name: enable kubelet service
  systemd:
    name: kubelet
    state: restarted
    daemon_reload: yes
    enabled: True

- name: set k8s master
  set_fact:
    k8s_master: "{{ groups['k8s_master_instances'][0] }}"
- name: debug join
  debug:
    msg: "master token: {{ hostvars[k8s_master].mastertoken }}"

- name: join k8s cluster
  shell: "kubeadm join --token {{ hostvars[k8s_master].mastertoken }} --discovery-token-unsafe-skip-ca-verification {{ k8s_master }}:6443"
  when: "{{ inventory_hostname not in groups['k8s_master_instances'] }}"
