---
- name: create /etc/contrail/config_database
  file:
    path: /etc/contrail/config_database
    state: directory
    recurse: yes

- name: set cassandra seeds to hostvars['localhost'].CONFIGDB_NODES if defined
  set_fact:
    cassandra_seeds: "{{ hostvars['localhost'].CONFIGDB_NODES }}"
  when: hostvars['localhost'].CONFIGDB_NODES is defined

- name: set cassandra seeds to hostvars['localhost'].CONTROLLER_NODES if hostvars['localhost'].CONFIGDB_NODES not defined
  set_fact:
    cassandra_seeds: "{{ hostvars['localhost'].CONTROLLER_NODES }}"
  when: hostvars['localhost'].CONTROLLER_NODES is defined and hostvars['localhost'].CONFIGDB_NODES is undefined

- name: set zookeeper nodes to hostvars['localhost'].CONFIGDB_NODES if defined
  set_fact:
    zookeeper_nodes: "{{ hostvars['localhost'].CONFIGDB_NODES }}"
  when: hostvars['localhost'].CONFIGDB_NODES is defined

- name: set zookeeper nodes to hostvars['localhost'].CONTROLLER_NODES if hostvars['localhost'].CONFIGDB_NODES not defined
  set_fact:
    zookeeper_nodes: "{{ hostvars['localhost'].CONTROLLER_NODES }}"
  when: hostvars['localhost'].CONTROLLER_NODES is defined and hostvars['localhost'].CONFIGDB_NODES is undefined

- name: set rabbit nodes to hostvars['localhost'].CONFIGDB_NODES if defined
  set_fact:
    rabbitmq_nodes: "{{ hostvars['localhost'].CONFIGDB_NODES }}"
  when: hostvars['localhost'].CONFIGDB_NODES is defined

- name: set rabbit nodes to hostvars['localhost'].CONTROLLER_NODES if hostvars['localhost'].CONFIGDB_NODES not defined
  set_fact:
    rabbitmq_nodes: "{{ hostvars['localhost'].CONTROLLER_NODES }}"
  when: hostvars['localhost'].CONTROLLER_NODES is defined and hostvars['localhost'].CONFIGDB_NODES is undefined

- name: update image
  shell: "docker pull {{ hostvars['localhost'].CONTAINER_REGISTRY }}/{{ item }}:{{ hostvars['localhost'].CONTRAIL_VERSION_TAG }}"
  with_items:
    - contrail-external-cassandra
    - contrail-external-zookeeper
    - contrail-external-rabbitmq
  when: UPDATE_IMAGES is undefined or UPDATE_IMAGES != false

- name: create contrail config database compose file
  template:
    src: contrail-config-database.yaml.j2
    dest: /etc/contrail/config_database/docker-compose.yaml

- name: start contrail config database
  docker_service:
    project_src: /etc/contrail/config_database
