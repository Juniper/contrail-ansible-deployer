---
kolla_globals: "{{ kolla_config.kolla_globals if kolla_config.kolla_globals is defined else default_kolla_globals}}"

# Pick first instance's IP as a default
os_node_control: "{{ hostvars[inventory_hostname]['ansible_' + network_interface_detected].get('ipv4',{}).get('address', 'no_ip_for_ctrl_iface') }}"

os_node_mgmt: "{{ hostvars[inventory_hostname]['ansible_' + external_interface_detected].get('ipv4',{}).get('address', 'no_ip_for_mgmt_iface') }}"

# This cannot be derived in all scenarios. This is because the
# create_openstack_config is run only on openstack_nodes. So we can not know the
# actual ctrl-data-ip of the contrail nodes unless they are colocated with
# openstack role. So just use mgmt IP and let user specify the ctrl-data-ip
# This might throw an error if the contrail node did not have an interface
# named {{ network_interface_detected }}:
# {%- do node_list.append(hostvars[v.ip]['ansible_' + network_interface_detected].get('ipv4').get('address')) -%}
contrail_node_control: >-
    {%- set node_list = [] -%}
    {%- for k,v in instances.iteritems() -%}
      {%- set ctrl_if = hostvars[v.ip].get('ansible_' + network_interface_detected, {}) -%}
      {%- set ctrl_ip = v.ip -%}
      {%- if ctrl_if -%}
        {%- set ctrl_ip = ctrl_if.get('ipv4').get('address') -%}
      {%- endif -%}
      {%- if v.roles is not defined -%}
        {%- do node_list.append(ctrl_ip) -%}
      {%- elif v.roles.control is defined -%}
        {%- do node_list.append(ctrl_ip) -%}
      {%- endif -%}
    {%- endfor -%}
    {{ node_list | first }}

container_registry: >-
    {%- if contrail_configuration is defined and contrail_configuration['CONTAINER_REGISTRY'] is defined -%}
      {%- print contrail_configuration['CONTAINER_REGISTRY'] -%}
    {%- else -%}
      {%- print 'opencontrailnightly' -%}
    {%- endif -%}

contrail_tag: >-
    {%- if contrail_configuration is defined and contrail_configuration['CONTRAIL_VERSION'] is defined %}
      {%- print contrail_configuration['CONTRAIL_VERSION'] -%}
    {%- else -%}
      {%- print 'latest' -%}
    {%- endif -%}

external_interface_detected: >-
  {%- if kolla_config.kolla_globals is defined and kolla_config.kolla_globals.kolla_external_vip_interface is defined -%}
      {{ kolla_config.kolla_globals.kolla_external_vip_interface }}
  {%- elif contrail_configuration.CONTROL_DATA_NET_LIST is defined -%}
    {%- for iface in ansible_interfaces if hostvars[inventory_hostname]['ansible_' + iface].get('ipv4',{}).get('address', None) == inventory_hostname -%}
      {{ iface }}{%- endfor -%}
  {%- else -%}
    {{ network_interface_detected }}
  {%- endif -%}

instance_data: "{{ instances[hostvars[inventory_hostname].instance_name] }}"

network_interface_detected: >-
    {%- set int_dict = instances|ctrl_data_intf_dict(contrail_configuration, kolla_config if kolla_config is defined else {}, hostvars) -%}
    {{ int_dict.get(inventory_hostname, 'eth0') }}
