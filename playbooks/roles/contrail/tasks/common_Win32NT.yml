---

- name: merge contrail_configuration dicts
  set_fact:
    contrail_configuration: "{{ contrail_configuration_default | combine(contrail_configuration) }}"

- name: set ANALYTICS_NODES var
  set_fact:
    contrail_configuration: "{{ contrail_configuration | combine( { 'ANALYTICS_NODES': contrail_configuration.CONTROLLER_NODES } ) }}"
  when: contrail_configuration.ANALYTICS_NODES is not defined

- name: set CONFIG_NODES var
  set_fact:
    contrail_configuration: "{{ contrail_configuration | combine( { 'CONFIG_NODES': contrail_configuration.CONTROLLER_NODES } ) }}"
  when: contrail_configuration.CONFIG_NODES is not defined

- name: set CONTROL_NODES var
  set_fact:
    contrail_configuration: "{{ contrail_configuration | combine( { 'CONTROL_NODES': contrail_configuration.CONTROLLER_NODES } ) }}"
  when: contrail_configuration.CONTROL_NODES is not defined

- name: set DNS_NODES var
  set_fact:
    contrail_configuration: "{{ contrail_configuration | combine( { 'DNS_NODES': contrail_configuration.CONTROL_NODES } ) }}"
  when: contrail_configuration.DNS_NODES is not defined

- name: create artifacts directory
  win_file:
    path: "{{ win_host_artifacts_dir }}"
    state: directory

- name: create logs directory
  win_file:
    path: C:\ProgramData\Contrail\var\log\contrail
    state: directory

- name: ensure configuration folder exists
  win_file:
    path: C:\ProgramData\Contrail\etc\contrail
    state: directory

- name: enable kernel crashdumps collection (will appear in $Env:SystemRoot)
  win_shell: >
    Get-WmiObject -Class Win32_OSRecoveryConfiguration -EnableAllPrivileges | Set-WmiInstance -Arguments @{ DebugInfoType=1; OverwriteExistingDebugFile=$false }

- name: enable usermode crashdumps collection (will appear in $Env:LocalAppData\CrashDumps)
  win_shell: |
    $DumpsPath = "Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\Windows Error Reporting\LocalDumps"
    New-Item -Force -Path $DumpsPath
    New-ItemProperty -Force -Path $DumpsPath -Name DumpFolder -Value %LOCALAPPDATA%\CrashDumps -Type ExpandString
    New-ItemProperty -Force -Path $DumpsPath -Name DumpCount -Value 10 -Type DWord
    New-ItemProperty -Force -Path $DumpsPath -Name DumpType -Value 2 -Type DWord
