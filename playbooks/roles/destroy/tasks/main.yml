---
- name: find all directories
  find:
    path: /etc/contrail
    file_type: directory
  register: dir_out

- name: Get name of the vrouter container
  command: docker ps --filter name=vrouter-agent --format {%raw%}"{{.Names}}"{%endraw%}
  register: result_name
  when: roles[instance_name].vrouter is defined

- name: Make sure Vrouter container exists on this node
  shell: >
    docker ps | grep vrouter_vrouter-agent_1 | grep Up | awk '{print $1}'
  run_once: yes
  register: vrouter_exists

- name: Send QUIT signal to vrouter
  command:
    docker kill -s QUIT "{{ result_name.stdout }}"
  when:
    - roles[instance_name].vrouter is defined
    - vrouter_exists.stdout

- name: skip invalid dir which doesn't have compose file
  stat:
    path: "{{ item.path }}/docker-compose.yaml"
  register: rc
  with_items: "{{ dir_out.files }}"

- docker_service:
    project_src: "{{ item.item.path }}"
    state: absent
    remove_images: all
    remove_volumes: yes
  with_items: "{{ rc.results }}"
  when: item.stat.exists == true
