---

# this file is parameterized
# it takes 'docker_registry' as a parameter that should be added to insecure_registry list

- name: register /etc/docker/daemon.json
  stat:
    path: /etc/docker/daemon.json
  register: p

- block:
    - name: create /etc/docker directory
      file:
        path: /etc/docker
        state: directory
        mode: 0755

    - name: create /etc/docker/daemon.json if it doesn't exist
      copy:
        content: "{}"
        dest: /etc/docker/daemon.json

  when: not p.stat.exists

- name: read /etc/docker/daemon.json if it exists
  shell: cat /etc/docker/daemon.json
  register: docker_daemon_file

- name: set entries to json if file exists
  set_fact:
    docker_daemon: "{{ docker_daemon_file.stdout | from_json }}"

- name: register insecure-registries
  set_fact:
    insecure_registries: "{{ docker_daemon['insecure-registries'] | default([]) }}"

- name: check if file update is needed
  set_fact:
    docker_daemon_update_needed: True
  when: docker_registry not in insecure_registries

- block:
    - name: append docker registry to insecure-registries if it isn't already in
      set_fact:
        insecure_registries: "{{ insecure_registries + [docker_registry] }}"

    - name: insert new insecure-registries to docker daemon
      set_fact:
        docker_daemon: "{{ docker_daemon | combine({ 'insecure-registries': insecure_registries}) }}"

    - name: empty existing file
      copy:
        content: ""
        dest: /etc/docker/daemon.json

    - name: write to /etc/docker/daemon.json
      lineinfile:
        dest: /etc/docker/daemon.json
        line: "{{ docker_daemon | to_nice_json }}"

    - name: reload systemd
      shell: systemctl daemon-reload
      when: ansible_os_family == 'RedHat'

    - name: start docker daemon
      service:
        enabled: yes
        name: docker
        state: restarted

  when: docker_daemon_update_needed is defined
