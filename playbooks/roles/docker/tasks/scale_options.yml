---
- name: create docker config directory if required
  file:
    path: "{{ nix_docker_config_directory }}"
    state: directory
    mode: 0755

- name: ensure docker config file exists
  file:
    path: "{{ nix_docker_config_file }}"
    state: touch

- name: read docker config file
  shell: "cat {{ nix_docker_config_file }}"
  register: docker_daemon_file

- name: convert entries to json
  set_fact:
    docker_daemon: "{{ docker_daemon_file.stdout | default('{}', true) | from_json }}"

- name: insert updated max-concurrent-downloads to docker daemon
  set_fact:
    new_docker_daemon: "{{ docker_daemon | combine({ 'max-concurrent-downloads': 1 }) }}"
  when: docker_daemon['max-concurrent-downloads'] is not defined

- name: write config to daemon.json
  copy:
    content: "{{ new_docker_daemon | to_nice_json }}"
    dest: "{{ nix_docker_config_file }}"
  when: new_docker_daemon is defined
  notify:
    - reload systemd
    - restart docker daemon

