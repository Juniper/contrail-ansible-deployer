---

- include: inventory.yml

- fail: 
    msg: "kolla_internal_vip_address is mandatory for a multi-node cluster"
  when:
    - (openstack_nodes| count) > 1
    - kolla_config.kolla_globals is not defined or kolla_config.kolla_globals.kolla_internal_vip_address is not defined 

- name: Calculate openstack_network_interface
  set_fact:
    openstack_network_interface: "{{ item[0] }}"
  when: >
    (hostvars[inventory_hostname]['ansible_%s' % item[0]]|default({}))
    .get('ipv4', {}).get('address') == openstack_node
    or
    openstack_node in ((hostvars[inventory_hostname]['ansible_%s' % item[0]]|default({}))
    .get('ipv4_secondaries'))|map(attribute='address')|list
  delegate_to: "{{ item[1] }}"
  with_nested:
    - "{{ ansible_interfaces }}"
    - "{{ openstack_nodes }}"

- name: Merge kolla_globals params
  set_fact:
    final_kolla_globals: "{{ default_kolla_globals |combine(kolla_globals) if kolla_globals is defined else default_kolla_globals }}"

- name: Populate etc/kolla/globals.yml
  template:
    src: "{{ role_path }}/templates/globals.yml.j2"
    dest: "{{ kolla_dir }}/etc/kolla/globals.yml"

